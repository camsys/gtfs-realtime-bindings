name: Python PR Checks

on:
  pull_request:
    paths:
      - python/**
      - '.github/workflows/python-pr.yml'
  workflow_dispatch:

jobs:
  test:
    name: Run python tests matrix
    needs: check_version_bump
    uses: ./.github/workflows/python-test.yml
    with:
      python-versions: '["3.8", "3.11"]'
      package-path: 'python'
      test-path: 'tests'
      debug: false

  check_version_bump:
    name: Check version bump in pyproject.toml
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get base branch
        run: |
          echo "BASE_REF=${{ github.event.pull_request.base.ref }}" >> $GITHUB_ENV

      - name: Fetch base branch
        run: |
          git fetch origin ${{ env.BASE_REF }}

      - name: Compare version in pyproject.toml
        run: |
          PR_VERSION=$(grep '^version' python/pyproject.toml | head -1 || true)
          BASE_VERSION=$(git show origin/${{ env.BASE_REF }}:python/pyproject.toml | grep '^version' | head -1 || true)
          echo "PR version: $PR_VERSION"
          echo "Base version: $BASE_VERSION"
          if [ "$PR_VERSION" = "$BASE_VERSION" ]; then
            echo "::warning file=python/pyproject.toml,line=1,title=pyproject.toml version::Version in python/pyproject.toml was not bumped"
          fi